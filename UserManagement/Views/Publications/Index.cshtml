@model PagedList.IPagedList<UserManagement.Models.db.Publication>
@using PagedList.Mvc;
@using UserManagement.Models.db;
@{
    ViewBag.Title = "Публікації";
}

<h2>Публікації</h2>

<form asp-controller="Publications" asp-action="Index" id="mainFrom" style="width: 100%; text-align: center;">
    <div style="display: flex; justify-content: space-between">
        <div>
            <label>Назва</label>
            <input type="text" name="SearchString" value="@ViewBag.searchString">
        </div>
        <input type="hidden" name="isMine" value="@((bool)ViewBag.isMine ? "True" : "False")"/>
        @if ((ViewBag.isMine && User.IsInRole("Адміністрація ректорату")) || !ViewBag.isMine)
        {
        <div>
            <label>Факультет</label>
            @Html.DropDownList("faculty",
                          new SelectList(ViewBag.AllFaculties, "Value", "Text", ViewBag.facultyNumber),
                          "Виберіть факультет",
                          new { @class = "form-control chosen-select-faculty", @Value = ViewBag.faculty })
        </div>
        }
        @if ((ViewBag.isMine && User.IsInRole("Адміністрація деканату")) || !ViewBag.isMine)
        {
            <div>
                <div class="form-group">
                    <label>Кафедра</label>
                    <input type="hidden" name="cathedra" value="@ViewBag.cathedra" />
                    <input list="cathedra-selector" name="cathedraName" autocomplete="off" style="height:25px;" value="@ViewBag.cathedraName" />
                    <datalist id="cathedra-selector">
                        @foreach (var cathedra in ViewBag.AllCathedras)
                        {
                            <option value='@cathedra.Name' data-faculty='@cathedra.Faculty.ID' data-id="@cathedra.ID">@cathedra.Name</option>
                        }
                    </datalist>
                </div>
            </div>
        }
        @if ((ViewBag.isMine 
            && (User.IsInRole("Адміністрація ректорату") 
            || User.IsInRole("Адміністрація деканату") 
            || User.IsInRole("Керівник кафедри"))) || !ViewBag.isMine)
        {
        <div>
            <label>Користувач</label>
            @Html.DropDownList("user",
                          new SelectList(ViewBag.AllUsers, "Value", "Text", ViewBag.userId),
                          "Виберіть користувача",
                          new { @class = "form-control chosen-select", @Value = ViewBag.user })
        </div>
        }
        <div>
            <label>З: </label>
            <input type="date" name="dateFrom" value="@ViewBag.dateFrom" />
        </div>
        <div>
            <label>До: </label>
            <input type="date" name="dateTo" value="@ViewBag.dateTo">
        </div>
    </div>
    <div style="height: 50%;padding-top: 15px; display: inline-block;">
        <input type="submit" value="Пошук" style="width: 100%"/>
    </div>
</form>
<div style="display: flex; justify-content: space-between">
    @Html.ActionLink("Створити", "Create")
    @{ 
        var text = User.IsInRole("Адміністрація ректорату") ? "Публікації університету"
            : User.IsInRole("Адміністрація деканату") ? "Публікації факультету"
            : User.IsInRole("Керівник кафедри") ? "Публікації кафедри"
            : "Мої публікації";
    }
    @Html.ActionLink(!ViewBag.isMine ? text : "Всі публікації", "Index",
        new
            {
                searchString = ViewBag.searchString,
            isMine = !ViewBag.isMine,
            page = ViewBag.page,
            dateFrom = ViewBag.dateFrom,
            dateTo = ViewBag.dateTo
            })
</div>
<br />

<table class="table">
    <tr>
        <th>
            Назва
        </th>
        <th>
            Дата
        </th>
        <th>
            Тип
        </th>
        <th>
            Автори
        </th>
        <th>
            Інші автори
        </th>
        <th></th>
    </tr>

    @foreach (var item in Model)
    {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Name)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Date)
            </td>
            <td>
                @item.PublicationType.ToString().Replace('_', ' ')
            </td>
            <td>
                @foreach (var user in item.User)
                {
                    foreach (var initial in user.I18nUserInitials)
                    {
                        if (initial.Language == item.Language)
                        {
                            <label style="font-weight:unset">@initial.FirstName @initial.LastName</label>
                            break;
                        }
                    }
                }
            </td>
            <td>
                @if (item.OtherAuthors == null || item.OtherAuthors == "")
                {
                    <span>-</span>
                }
                else
                {
                    @Html.DisplayFor(modelItem => item.OtherAuthors)
                }
            </td>
            <td>

                @if (item.User.Any(x => x.UserName == User.Identity.Name))
                {
                    @Html.ActionLink("Редагувати", "Edit", new { id = item.ID })
                }
                @Html.ActionLink("Деталі", "Details", new { id = item.ID })

                @if (item.User.Any(x => x.UserName == User.Identity.Name))
                {
                    @Html.ActionLink("Видалити", "Delete", new { id = item.ID })
                }
            </td>
        </tr>
    }

</table>
Сторінка @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) з @Model.PageCount

@Html.PagedListPager(Model, page => Url.Action("Index", 
    new { page, isMine = ViewBag.isMine,
        isFaculty = ViewBag.isFaculty,
        faculty=ViewBag.faculty,
        cathedra=ViewBag.cathedra,
        user=ViewBag.user,
        searchString = ViewBag.searchString,
        dateFrom = ViewBag.dateFrom,
        dateTo = ViewBag.dateTo
    }))

<link rel="stylesheet" href="../Scripts/docsupport/style.css">
<link rel="stylesheet" href="../Scripts/docsupport/prism.css">
<link rel="stylesheet" href="../Scripts/chosen.css">
<style type="text/css" media="all">
    /* fix rtl for demo */
    .chosen-rtl .chosen-drop {
        left: -9000px;
    }

    .find {
        height: 30px;
        margin-left: 15px;
    }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script src="../Scripts/chosen.jquery.js" type="text/javascript"></script>
<script src="../Scripts/docsupport/prism.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
    let cathedrasSelectOptions = document.getElementById("cathedra-selector").options;
    var opts = [];
    for (var i = 0; i < cathedrasSelectOptions.length; i++) {
        opts.push({ value: cathedrasSelectOptions[i].value, faculty: cathedrasSelectOptions[i].dataset.faculty, id: cathedrasSelectOptions[i].dataset.id });
    }
    function updateSelect() {
        $('.chosen-select').on("change", function () {
            $('#cathedraForm').submit();
        })
        $('.chosen-select-faculty').on("change", function () {
            $('#facultyForm').submit();
        })
        $('.chosen-select').chosen(
            {
                allow_single_deselect: false,
                disable_search_threshold: 10,
                no_results_text: 'Не знайдено',
            }
        );
        $('.chosen-select-faculty').chosen(
            {
                allow_single_deselect: false,
                disable_search_threshold: 10,
                no_results_text: 'Не знайдено',
            }
        );
    }
    function submitDate() {
        $('#dateForm').submit();
    }
    function addFacultyPickerListener() {
        let facultyElem = document.getElementById("faculty");
        $('#faculty').change(function (e) {
            var str = "";
            if (facultyElem.value === "") {
                for (var i = 0; i < opts.length; i++) {
                    str += `<option value='${opts[i].value}' data-faculty='${opts[i].faculty}' data-id='${opts[i].id}'>${opts[i].value}</option>`;
                }
            } else {
                for (var i = 0; i < opts.length; i++) {
                    if (opts[i].faculty == facultyElem.value) {
                        str += `<option value='${opts[i].value}' data-faculty='${opts[i].faculty}' data-id='${opts[i].id}'>${opts[i].value}</option>`;
                    }
                }
            }
            document.getElementById("cathedra-selector").innerHTML = str;
        });
    }
    addFacultyPickerListener();
    updateSelect();
    $(document).on('change', 'input[name="cathedraName"]', function () {
        var optionslist = $('datalist')[0].options;
        var value = $(this).val();
        for (var x = 0; x < optionslist.length; x++) {
            if (optionslist[x].value === value) {
                $('input[name=cathedra]').val(optionslist[x].dataset.id);
            }
        }
    });
    $('#faculty').change();
</script>