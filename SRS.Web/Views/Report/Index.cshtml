@using Microsoft.AspNet.Identity
@using SRS.Services.Models.Constants
@model SRS.Web.Models.Reports.ReportViewModel
@{
    ViewBag.Title = "Індивідуальний звіт";
}

<h2>Індивідуальний звіт</h2>

<div id="wizard">
    <h3>Наукова робота</h3>
    <section class="section-body">
        @using (@Html.BeginForm("UpdateScientificWork", "Report", FormMethod.Post, new { @id = "updateThemeForm" }))
        {
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label class="control-label">
                    1. Теми наукової роботи:
                </label>
                <div>
                    <label class="text-danger">
                        <span class="text-danger">*</span>
                        Якщо теми не є зареєстрованими, перейдіть у вкладку "Інше" та введіть їх у пункті 10
                    </label>
                </div>
                <div>
                    <div id="scientific-work-search" class="search-container">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1"><i class="bi bi-search"></i></span>
                            <input class="form-control" placeholder="Пошук за назвою, номером, шифром, науковим керівником" />
                        </div>
                        <div class="search-results">
                        </div>
                    </div>
                    @if (Model.ThemeOfScientificWorks != null)
                    {
                        for (var i = 0; i < Model.ThemeOfScientificWorks.Count; i++)
                        {
                            <input type="hidden" class="initial-scientific-work"
                                   data-id="@Model.ThemeOfScientificWorks[i].ThemeOfScientificWorkId"
                                   data-themeid="@Model.ThemeOfScientificWorks[i].Id"
                                   data-themenumber="@Model.ThemeOfScientificWorks[i].ThemeOfScientificWork.ThemeNumber"
                                   data-code="@Model.ThemeOfScientificWorks[i].ThemeOfScientificWork.Code"
                                   data-scientifichead="@Model.ThemeOfScientificWorks[i].ThemeOfScientificWork.ScientificHead"
                                   data-value="@Model.ThemeOfScientificWorks[i].ThemeOfScientificWork.Value"
                                   data-description="@Model.ThemeOfScientificWorks[i].Description"
                                   data-resume="@Model.ThemeOfScientificWorks[i].Resume"
                                   data-supervisorid="@Model.ThemeOfScientificWorks[i].ThemeOfScientificWork.SupervisorId"
                                   data-publications="@Model.ThemeOfScientificWorks[i].Publications"
                                   data-defendeddissertation="@Model.ThemeOfScientificWorks[i].DefendedDissertation"/>
                        }
                    }
                    <div class="selected-items selected-scientific-works">
                    </div>
                </div>
            </div>
            <div class="form-group" style="display:none">
                <label class="control-label">
                    Опис наукової роботи:
                </label>
                <div>
                    @Html.TextAreaFor(model => model.OtherThemeOfScientificWorkDescription, 6, 70, new
                    {
                        @class = "form-control",
                        @style = "max-width: 100%",
                        @Value = Model.OtherThemeOfScientificWorkDescription,
                    })
                </div>
            </div>

            <div class="form-group">
                <label class="control-label">
                    2. Участь у виконанні індивідуальних або колективних ґрантів (окрім ґрантів на поїздки) − згідно з додатком 3:
                </label>
                <div>
                    <label class="text-danger">
                        <span class="text-danger">*</span>
                        Якщо ґранти не є зареєстрованими, перейдіть у вкладку "Інше" та введіть їх у пункті 10
                    </label>
                </div>
                <div>
                    <div id="grant-search" class="search-container">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1"><i class="bi bi-search"></i></span>
                            <input class="form-control" placeholder="Пошук за назвою, номером, шифром, науковим керівником" />
                        </div>
                        <div class="search-results">
                        </div>
                    </div>
                    @if (Model.Grants != null)
                    {
                        for (var i = 0; i < Model.Grants.Count; i++)
                        {
                            <input type="hidden" class="initial-grant"
                                   data-id="@Model.Grants[i].ThemeOfScientificWorkId"
                                   data-themeid="@Model.Grants[i].Id"
                                   data-themenumber="@Model.Grants[i].ThemeOfScientificWork.ThemeNumber"
                                   data-code="@Model.Grants[i].ThemeOfScientificWork.Code"
                                   data-scientifichead="@Model.Grants[i].ThemeOfScientificWork.ScientificHead"
                                   data-value="@Model.Grants[i].ThemeOfScientificWork.Value"
                                   data-description="@Model.Grants[i].Description" />
                        }
                    }
                    <div class="selected-items selected-grants">
                    </div>
                </div>
            </div>
            <div class="form-group" style="display:none">
                <label class="control-label">
                    Опис грантів:
                </label>
                <div>
                    @Html.TextAreaFor(model => model.OtherGrantDescription, 6, 70, new
                    {
                        @class = "form-control",
                        @style = "max-width: 100%",
                        @Value = Model.OtherGrantDescription,
                    })
                </div>
            </div>

            <div class="form-group">
                <label class="control-label">
                    3. Наукові стажування:
                </label>
                <div>
                    @Html.TextAreaFor(model => model.ScientificTrainings, 6, 70, new
                    {
                        @class = "form-control",
                        @style = "max-width: 100%",
                        @Value = Model.ScientificTrainings,
                    })
                </div>
            </div>

            <div class="form-group">
                <label class="control-label">
                    4. Наукове керівництво аспірантами, здобувачами, наукове консультування при написанні
                    докторських дисертацій. Захист дисертацій аспірантами, докторантами (прізвище, назва дисертації,
                    спеціальність, дата захисту, рік закінчення аспірантури, докторантури):
                </label>
                <div>
                    @Html.TextAreaFor(model => model.ScientificControlDoctorsWork, 6, 70, new
                    {
                        @class = "form-control",
                        @style = "max-width: 100%",
                        @Value = Model.ScientificControlDoctorsWork,
                    })
                </div>
            </div>

            <div class="form-group">
                <label class="control-label">
                    5. Керівництво студентською науковою роботою, спільні публікації, керівництво студентськими
                    гуртками, підготовка студентів для участі у Всеукраїнських конкурсах студентських наукових робіт
                    тощо:
                </label>
                @if (Model.StudentPublication.Count > 0)
                {
                    <div class="publication-block">
                        <p class="publication-header">
                            Публікації зі студентами:
                        </p>
                        @Html.EditorFor(model => model.StudentPublication)
                    </div>
                }
                <div class="publication-block">
                    @Html.TextAreaFor(model => model.ScientificControlStudentsWork, 6, 70, new
                    {
                        @class = "form-control",
                        @style = "max-width: 100%",
                        @Value = Model.ScientificControlStudentsWork,
                    })
                </div>
            </div>
            <input type="hidden" name="stepIndex" value="@ViewBag.stepIndex" id="stepIndex_2" />
            <input type="hidden" name="Id" value="@Model.Id" />
        }
    </section>

    <h3>Публікації</h3>
    <section class="section-body">
        <form asp-controller="Report" asp-action="Index" id="dateForm">
            <div class="form-group">
                <label class="control-label">
                    Період з
                </label>
                <div>
                    <input name="publicationDateFrom" type="date" class="form-control" value="@(ViewBag.PublicationDateFrom != null ? ((DateTime?)ViewBag.PublicationDateFrom).Value.ToString(Dates.DatePattern) : "")" min="@Dates.MinDate.ToString(Dates.DatePattern)" max="@Dates.MaxDate.ToString(Dates.DatePattern)" />
                </div>
            </div>
            <div class="form-group">
                <label class="control-label">
                    Період до
                </label>
                <div>
                    <input name="publicationDateTo" type="date" class="form-control" value="@(ViewBag.PublicationDateTo != null ? ((DateTime?)ViewBag.PublicationDateTo).Value.ToString(Dates.DatePattern) : "")" min="@Dates.MinDate.ToString(Dates.DatePattern)" max="@Dates.MaxDate.ToString(Dates.DatePattern)" />
                </div>
            </div>
            <input type="hidden" name="stepIndex" value="@ViewBag.StepIndex" />
            <input type="hidden" name="reportId" value="@Model.Id" />
            <button type="submit" class="btn btn-default">Пошук</button>
        </form>
        @using (@Html.BeginForm("UpdatePublications", "Report", FormMethod.Post, new { @id = "updatePublicationForm" }))
        {
            @Html.AntiForgeryToken()
            if (Model.PrintedPublication.Count > 0)
            {
                <div class="publication-block">
                    <p class="publication-header">
                        Праці, що вийшли з друку:
                    </p>
                    @Html.EditorFor(model => model.PrintedPublication)
                </div>
            }
            if (Model.RecomendedPublication.Count > 0)
            {
                <div class="publication-block">
                    <p class="publication-header">
                        Праці, рекомендовані Вченою радою університету до друку:
                    </p>
                    @Html.EditorFor(model => model.RecomendedPublication)
                </div>
            }
            if (Model.AcceptedToPrintPublication.Count > 0)
            {
                <div class="publication-block">
                    <p class="publication-header">
                        Статті, прийняті до друку:
                    </p>
                    @Html.EditorFor(model => model.AcceptedToPrintPublication)
                </div>
            }
            if (Model.ApplicationsForInvention.Count > 0)
            {
                <div class="publication-block">
                    <p class="publication-header">
                        Заявки на винахід:
                    </p>
                    @Html.EditorFor(model => model.ApplicationsForInvention)
                </div>
            }
            if (Model.PatentsForInvention.Count > 0)
            {
                <div class="publication-block">
                    <p class="publication-header">
                        Патенти на винахід:
                    </p>
                    @Html.EditorFor(model => model.PatentsForInvention)
                </div>
            }
            if (Model.PrintedPublication.Count == 0
                && Model.RecomendedPublication.Count == 0
                && Model.AcceptedToPrintPublication.Count == 0
                && Model.ApplicationsForInvention.Count == 0
                && Model.PatentsForInvention.Count == 0)
            {
                <p style="margin-top:100px">
                    Немає публікацій за цей період.
                </p>
            }
            <input type="hidden" name="stepIndex" id="stepIndex_1" />
            <input type="hidden" name="Id" value="@Model.Id" />
        }
    </section>

    <h3>Інше</h3>
    <section class="section-body">
        @using (@Html.BeginForm("UpdateOtherInfo", "Report", FormMethod.Post, new { @id = "updateOtherForm" }))
        {
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label class="control-label">
                    8. Рецензування та опонування дисертацій, відгуки на автореферати, експертні висновки:
                </label>
                <div>
                    @Html.TextAreaFor(model => model.ReviewForTheses, 6, 70, new
                    {
                        @class = "form-control",
                        @style = "max-width: 100%",
                        @Value = Model.ReviewForTheses,
                    })
                </div>
            </div>

            <div class="form-group">
                <label class="control-label">
                    9. Членство у спеціалізованих вчених, експертних радах, редколегіях наукових журналів тощо:
                </label>
                <div>
                    @Html.TextAreaFor(model => model.MembershipInCouncils, 6, 70, new
                    {
                        @class = "form-control",
                        @style = "max-width: 100%",
                        @Value = Model.MembershipInCouncils,
                    })
                </div>
            </div>

            <div class="form-group">
                <label class="control-label">
                    10. Інше:
                </label>
                <div>
                    @Html.TextAreaFor(model => model.Other, 6, 70, new
                    {
                        @class = "form-control",
                        @style = "max-width: 100%",
                        @Value = Model.Other,
                    })
                </div>
            </div>
            <input type="hidden" name="stepIndex" value="@ViewBag.stepIndex" id="stepIndex_3" />
            <input type="hidden" name="Id" value="@Model.Id" />
        }
    </section>

    <h3>Дата та протокол</h3>
    <section class="section-body">
        @using (@Html.BeginForm("UpdateFinalInfo", "Report", FormMethod.Post, new { @id = "updateFinishForm" }))
        {
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label class="control-label">
                    Дата:
                </label>
                <div>
                    @Html.EditorFor(model => model.Date, new { htmlAttributes = new { @class = "form-control", max = new DateTime(DateTime.Now.Year, 12, 31).ToString(Dates.DatePattern) } })
                </div>
            </div>

            <div class="form-group">
                <label class="control-label">
                    Протокол (лише числове значення):
                </label>
                <div>
                    @Html.TextBoxFor(model => model.Protocol, new { @class = "form-control" })
                    @{Html.RenderPartial("Common/InfoBox", "Приклад: 5 або 5/20");}
                </div>
            </div>
            @Html.ValidationSummary("", new { @class = "text-danger" })
            <input type="hidden" name="stepIndex" value="@ViewBag.stepIndex" id="stepIndex_4" />
            <input type="hidden" name="Id" value="@Model.Id" />
        }
    </section>
    <h3>Завершення</h3>
    <section class="section-body">
        @using (@Html.BeginForm("Finalize", "Report", FormMethod.Post, new { @id = "finalizeForm" }))
        {
            @Html.AntiForgeryToken()
            <div style="text-align: center;
                        margin: 20px;
                        font-size: 22px;
                        color: green;">
                Ваш звіт успішно заповнено!
            </div>
            <input type="hidden" name="stepIndex" value="@ViewBag.stepIndex" id="stepIndex_4" />
            <input type="hidden" name="Id" value="@Model.Id" />
        }
        <div style="padding-top: 50px;">
            <div style="display: flex; justify-content: space-evenly;">
                @Html.ActionLink("Експорт у PDF", "PreviewPdf", "ReportGeneration", new { reportId = Model.Id }, new { @class = "btn btn-default", @target = "_blank" })
                @Html.ActionLink("Експорт у LaTex", "GetLatex", "ReportGeneration", new { reportId = Model.Id }, new { @class = "btn btn-default" })
                @Html.ActionLink("Експорт у Word (тест-версія)", "GetWord", "ReportGeneration", new { reportId = Model.Id }, new { @class = "btn btn-default" })
                <a href="@Url.Action("Preview", "ReportGeneration", new { reportId = Model.Id })"
                   target="_blank"
                   class="btn btn-default">
                    Переглянути
                </a>
            </div>
            @if (Model.Date.HasValue && !string.IsNullOrEmpty(Model.Protocol))
            {
                <div style="display: flex; justify-content: center; padding-top: 16px">
                    @using (Html.BeginForm("Sign", "ReportList"))
                    {
                        @Html.AntiForgeryToken()
                        @Html.Hidden("reportId", Model.Id)
                        <button type="submit" class="btn btn-primary" id="signButton">Зберегти і завершити</button>
                    }
                </div>
                <div style="display: flex; justify-content: center; padding-top: 8px" class="text-danger"><span>*</span>Після цієї дії звіт стане доступним для адміністратора кафедри</div>
            }
        </div>
    </section>
</div>


@section Styles {
    <script>
        var CurrentUserId = "@User.Identity.GetUserId()";
    </script>
    @Styles.Render("~/Content/chosen/bundle")
    @Styles.Render("~/Content/search/bundle")
    @Styles.Render("~/Content/steps/bundle")
    @Styles.Render("~/Content/reports/bundle")
}
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/chosen")
    @Scripts.Render("~/bundles/steps")
    @Scripts.Render("~/bundles/stepper")
    @Scripts.Render("~/bundles/searchComponent")
    @Scripts.Render("~/bundles/reports/edit")
}
